<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T.R.A.C.K. - {{ horse_name }} ã®æˆ¦æ­´</title>

    <link rel="icon" href="https://tvcdn.netkeiba.com/img.dir/campaign/2023/derby/common/img/sp/fv_horse_img.png"
        type="image/png">
    <link rel="apple-touch-icon"
        href="https://tvcdn.netkeiba.com/img.dir/campaign/2023/derby/common/img/sp/fv_horse_img.png">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
</head>

<body>
    <div class="container career-page">
        <div class="career-header-section">
            <h1 class="page-title">ğŸ‡{{ horse_name }} ã®æˆ¦æ­´ (T.R.A.C.K.)</h1>
            <a href="#" onclick="goBackToIndex()" class="nav-button back-to-odds">
                <i class="fas fa-arrow-left"></i> é¦¬åã‚ªãƒƒã‚ºä¸€è¦§ã«æˆ»ã‚‹
            </a>
        </div>

        <div class="chart-navigation-wrapper">
            <div class="chart-and-buttons">
                <div class="chart-area">
                    <h2>ã‚¹ã‚³ã‚¢æ™‚ç³»åˆ—æ¨ç§»</h2>
                    <canvas id="scoreChart"></canvas>
                </div>

                <div class="chart-buttons-bottom">
                    {# Prev button #}
                    {% if prev_horse_name %}
                        <a href="{{ url_for('horse_career_page', horse_name=prev_horse_name|urlencode, race_url=race_url_for_back|urlencode, year=year_for_back, month=month_for_back) }}" class="nav-arrow-button">
                            <i class="fas fa-chevron-left"></i> å‰ã®é¦¬
                        </a>
                    {% else %}
                        <div class="nav-arrow-button disabled" title="å‰ã®é¦¬ã¯ã„ã¾ã›ã‚“">
                            <i class="fas fa-chevron-left"></i> å‰ã®é¦¬
                        </div>
                    {% endif %}

                    {# Next button #}
                    {% if next_horse_name %}
                        <a href="{{ url_for('horse_career_page', horse_name=next_horse_name|urlencode, race_url=race_url_for_back|urlencode, year=year_for_back, month=month_for_back) }}" class="nav-arrow-button">
                            æ¬¡ã®é¦¬ <i class="fas fa-chevron-right"></i>
                        </a>
                    {% else %}
                        <div class="nav-arrow-button disabled" title="æ¬¡ã®é¦¬ã¯ã„ã¾ã›ã‚“">
                            æ¬¡ã®é¦¬ <i class="fas fa-chevron-right"></i>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="career-table-panel">
            <h2>å…¨æˆ¦æ­´è©³ç´°</h2>
            <div class="table-responsive">
                {% if horse_details %}
                    <table class="details-table">
                        <thead>
                            <tr>
                                {% for key in horse_details[0].keys() %}
                                    <th>{{ key }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in horse_details %}
                                <tr>
                                    {% for value in row.values() %}
                                        <td>{{ value }}</td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>æˆ¦æ­´ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        // Chart.jsã§ã‚°ãƒ©ãƒ•ã‚’æç”»ã™ã‚‹é–¢æ•°
        async function fetchDataAndDrawChart() {
            const horseName = "{{ horse_name | urlencode }}"; // URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦APIã«æ¸¡ã™
            const chartAreaDiv = document.querySelector('.chart-area');

            try {
                const response = await fetch(`/horse_career_data/${horseName}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (!data || !data.labels || data.labels.length === 0) {
                    chartAreaDiv.innerHTML = '<h2>ã‚¹ã‚³ã‚¢æ™‚ç³»åˆ—æ¨ç§»</h2><p>ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
                    return;
                }

                const ctx = document.getElementById('scoreChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: data.datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’å›ºå®šã—ãªã„
                        scales: {
                            x: {
                                type: 'category', // æ—¥ä»˜æ–‡å­—åˆ—ç”¨
                                labels: data.labels, // æ˜ç¤ºçš„ã«ãƒ©ãƒ™ãƒ«ã‚’è¨­å®š
                                title: {
                                    display: true,
                                    text: 'æ—¥ä»˜',
                                    color: '#f0f0f0' // ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒã«åˆã‚ã›ãŸè‰²
                                },
                                ticks: {
                                    color: '#e0e0e0' // ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒã«åˆã‚ã›ãŸè‰²
                                },
                                grid: {
                                    color: '#444444' // ã‚°ãƒªãƒƒãƒ‰ã®è‰²
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'ã‚¹ã‚³ã‚¢',
                                    color: '#f0f0f0' // ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒã«åˆã‚ã›ãŸè‰²
                                },
                                ticks: {
                                    color: '#e0e0e0' // ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒã«åˆã‚ã›ãŸè‰²
                                },
                                grid: {
                                    color: '#444444' // ã‚°ãƒªãƒƒãƒ‰ã®è‰²
                                }
                            }
                        },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                // â˜…å¤‰æ›´ã“ã“ã‹ã‚‰â˜… ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
                                title: (context) => {
                                    const dataIndex = context[0].dataIndex;
                                    const raceDetail = data.race_details[dataIndex]; // APIã‹ã‚‰å–å¾—ã—ãŸrace_detailsã‚’å‚ç…§

                                    let titleLines = [];
                                    titleLines.push(`æ—¥ä»˜: ${context[0].label}`); // æ—¥ä»˜ã‚’ã‚¿ã‚¤ãƒˆãƒ«ã«

                                    if (raceDetail) {
                                        titleLines.push(`ãƒ¬ãƒ¼ã‚¹: ${raceDetail['ãƒ¬ãƒ¼ã‚¹å']}`);
                                        // ãƒ¬ãƒ¼ã‚¹è©³ç´°æƒ…å ±ã‚’ã¾ã¨ã‚ã¦è¡¨ç¤º                                       
                                        if (raceDetail['èŠãƒ»ãƒ€'] && raceDetail['èŠãƒ»ãƒ€'] !== 'N/A') {
                                            titleLines.push(`èŠ/ãƒ€: ${raceDetail['èŠãƒ»ãƒ€']}`);
                                        }
                                        if (raceDetail['è·é›¢'] && raceDetail['è·é›¢'] !== 'N/A') {
                                            titleLines.push(`è·é›¢: ${raceDetail['è·é›¢']}`);
                                        }
                                        if (raceDetail['é¦¬å ´çŠ¶æ…‹'] && raceDetail['é¦¬å ´çŠ¶æ…‹'] !== 'N/A') {
                                            titleLines.push(`é¦¬å ´: ${raceDetail['é¦¬å ´çŠ¶æ…‹']}`);
                                        }
                                    }
                                    return titleLines; // é…åˆ—ã‚’è¿”ã™ã¨è¤‡æ•°è¡Œã«ãªã‚‹
                                },
                                // label ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯ã‚¹ã‚³ã‚¢æƒ…å ±ã®ã¿
                                label: (context) => {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(1); // ã‚¹ã‚³ã‚¢ã‚’å°æ•°ç‚¹ä»¥ä¸‹1æ¡ã§è¡¨ç¤º
                                    }
                                    return label;
                                },
                                // afterLabel ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å‰Šé™¤ã¾ãŸã¯nullã«ã™ã‚‹
                                afterLabel: (context) => {
                                    return null; // afterLabelã§ã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„
                                }
                                // â˜…å¤‰æ›´ã“ã“ã¾ã§â˜…
                            },
                            backgroundColor: 'rgba(0,0,0,0.7)', // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—èƒŒæ™¯è‰²
                            titleColor: '#ffffff', // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¿ã‚¤ãƒˆãƒ«è‰²
                            bodyColor: '#e0e0e0', // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—æœ¬æ–‡è‰²
                            borderColor: '#e50914', // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—æ ç·šè‰²
                            borderWidth: 1
                        },
                        legend: {
                            labels: {
                                color: '#e0e0e0' // å‡¡ä¾‹ã®ãƒ†ã‚­ã‚¹ãƒˆè‰²
                            }
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x', // Xè»¸æ–¹å‘ã®ã¿ãƒ‘ãƒ³å¯èƒ½
                                modifierKey: 'ctrl', // Ctrlã‚­ãƒ¼ã‚’æŠ¼ã—ãªãŒã‚‰ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ‘ãƒ³
                            },
                            zoom: {
                                wheel: {
                                    enabled: true, // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ 
                                },
                                pinch: {
                                    enabled: true // ãƒ”ãƒ³ãƒã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã§ã‚ºãƒ¼ãƒ 
                                },
                                mode: 'x', // Xè»¸æ–¹å‘ã®ã¿ã‚ºãƒ¼ãƒ å¯èƒ½
                            }
                        }
                    },
                    backgroundColor: '#1e1e1e' 
                }
            });
            } catch (error) {
                console.error('ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¾ãŸã¯æç”»ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                chartAreaDiv.innerHTML = '<h2>ã‚¹ã‚³ã‚¢æ™‚ç³»åˆ—æ¨ç§»</h2><p>ã‚°ãƒ©ãƒ•ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
            }
        }

        fetchDataAndDrawChart(); // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚°ãƒ©ãƒ•ã‚’æç”»


        // goBackToIndex é–¢æ•°: ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’POSTã§é€ã‚‹
        function goBackToIndex() {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/'; // indexãƒ«ãƒ¼ãƒˆã¸POST

            // Flaskã®sessionã‹ã‚‰æ¸¡ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ï¼ˆJinja2ã§tojson|urlencodeæ¸ˆã¿ï¼‰ã‚’
            // JavaScriptå´ã§decodeURIComponentã—ã¦ã‹ã‚‰hidden inputã«ã‚»ãƒƒãƒˆ
            const sessionData = {
                race_url: "{{ race_url_for_back | urlencode if race_url_for_back is not none else '' }}",
                year: "{{ year_for_back if year_for_back is not none else '' }}",
                month: "{{ month_for_back if month_for_back is not none else '' }}",
                
                // JSONæ–‡å­—åˆ—ã‚’URLãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ãã®ã¾ã¾hidden inputã®å€¤ã«ã™ã‚‹
                // app.pyå´ã§å†åº¦urllib.parse.unquoteã—ã¦ã‹ã‚‰json.loadsã§ãƒ‘ãƒ¼ã‚¹ã•ã‚Œã‚‹
                horse_list: decodeURIComponent("{{ session.get('horse_list', []) | tojson | urlencode }}"),
                schedule_data: decodeURIComponent("{{ session.get('schedule_data', []) | tojson | urlencode }}"),
                daily_races_data: decodeURIComponent("{{ session.get('daily_races_data', []) | tojson | urlencode }}")
            };

            for (const key in sessionData) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = sessionData[key]; 
                form.appendChild(input);
            }

            document.body.appendChild(form);
            form.submit();
        }
    </script>
</body>

</html>