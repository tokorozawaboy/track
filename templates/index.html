<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T.R.A.C.K.</title>
    <link rel="icon" href="https://tvcdn.netkeiba.com/img.dir/campaign/2023/derby/common/img/sp/fv_horse_img.png" type="image/png">
    <link rel="apple-touch-icon" href="https://tvcdn.netkeiba.com/img.dir/campaign/2023/derby/common/img/sp/fv_horse_img.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="panel">
            <h1>ğŸ‡T.R.A.C.K. v1.1</h1>

            <h2>é–‹å‚¬å¹´æœˆã‚’é¸æŠ</h2>
            <div class="input-group">
                <label for="year">å¹´:</label>
                <input type="number" id="year" value="" min="2023" max="2030">
                <label for="month">æœˆ:</label>
                <input type="number" id="month" value="" min="1" max="12">
                <button onclick="getSchedule()" id="getScheduleButton">
                    <i class="fas fa-calendar-alt"></i> ãƒ¬ãƒ¼ã‚¹æ—¥ç¨‹ã‚’å–å¾—
                </button>
            </div>

            <div id="mainRacesList" class="race-list">
                <h3>ãƒ¬ãƒ¼ã‚¹ä¸€è¦§:</h3>
                <p>å¹´æœˆã‚’é¸æŠã—ã¦ã€Œãƒ¬ãƒ¼ã‚¹æ—¥ç¨‹ã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
            <div id="loadingMainRaces" class="loader"></div>
        </div>

        <div class="panel">
            <div id="dailyRacesList" class="daily-race-list">
                <h3>åŒæ—¥é–‹å‚¬ã®å…¨ãƒ¬ãƒ¼ã‚¹:</h3>
                <p>ãƒ¬ãƒ¼ã‚¹æ—¥ç¨‹ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ã“ã“ã«åŒæ—¥é–‹å‚¬ã®ãƒ¬ãƒ¼ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            </div>
            <div id="loadingDailyRaces" class="loader"></div>
        </div>

        <div class="panel race-details-panel">
            <div id="raceDetails">
                <h3>ãƒ¬ãƒ¼ã‚¹è©³ç´°ã¨ã‚ªãƒƒã‚º:</h3>
                <button id="refreshOddsButton" style="display: none;">
                    <i class="fas fa-sync-alt"></i> ã‚ªãƒƒã‚ºã‚’æ›´æ–°
                </button>
                <p>åŒæ—¥é–‹å‚¬ã®ãƒ¬ãƒ¼ã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ã“ã“ã«é¦¬åã€ã‚ªãƒƒã‚ºãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            </div>
            <div id="loadingRaceDetails" class="loader"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const now = new Date();
            
            // Flaskã‹ã‚‰æ¸¡ã•ã‚ŒãŸåˆæœŸå€¤ã‚’ä½¿ç”¨
            const initialYear = {{ year | tojson }};
            const initialMonth = {{ month | tojson }};

            document.getElementById('year').value = initialYear !== null ? initialYear : now.getFullYear();
            document.getElementById('month').value = initialMonth !== null ? initialMonth : (now.getMonth() + 1);

            // ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ã«ã‚ˆã‚Š refreshOddsButton ã®ã‚¯ãƒªãƒƒã‚¯ã‚’æ¤œçŸ¥
            document.getElementById('raceDetails').addEventListener('click', (event) => {
                if (event.target.id === 'refreshOddsButton' || event.target.closest('#refreshOddsButton')) {
                    console.log("ã€Œã‚ªãƒƒã‚ºã‚’æ›´æ–°ã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚(ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²)");
                    if (currentRaceOddsUrl) {
                        getRaceOdds(currentRaceOddsUrl, true);
                    } else {
                        console.warn("currentRaceOddsUrlãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚ªãƒƒã‚ºã‚’æ›´æ–°ã§ãã¾ã›ã‚“ã€‚");
                    }
                }
            });

            // Flaskã‹ã‚‰æ¸¡ã•ã‚ŒãŸå¾©å…ƒãƒ‡ãƒ¼ã‚¿
            const isRestoringSession = {{ is_restoring_session | tojson }}; // æ–°ã—ã„ãƒ•ãƒ©ã‚°
            const initialRaceUrl = "{{ race_url_to_load if race_url_to_load is not none else '' }}";
            const initialHorseList = {{ initial_horse_list | tojson }};
            const initialScheduleData = {{ initial_schedule_data | tojson }};
            const initialDailyRacesData = {{ initial_daily_races_data | tojson }};

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´
            window.currentScheduleData = initialScheduleData;
            window.currentDailyRacesData = initialDailyRacesData;
            window.currentOddsData = initialHorseList; 
            currentRaceOddsUrl = initialRaceUrl;


            // isRestoringSessionãŒtrueã®å ´åˆã®ã¿ã€çŠ¶æ…‹å¾©å…ƒãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè¡Œ
            if (isRestoringSession) {
                console.log("ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒä¸­...");
                
                // 1. ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ä¸€è¦§ã®å¾©å…ƒ
                if (window.currentScheduleData && window.currentScheduleData.length > 0) {
                    displaySchedule(window.currentScheduleData);
                } else {
                    getSchedule(); 
                    console.warn("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€å†å–å¾—ã—ã¾ã™ã€‚");
                }

                // 2. åŒæ—¥é–‹å‚¬ãƒ¬ãƒ¼ã‚¹ä¸€è¦§ã®å¾©å…ƒ
                if (window.currentDailyRacesData && window.currentDailyRacesData.length > 0) {
                    displayDailyRaces(window.currentDailyRacesData);
                } else if (currentRaceOddsUrl) {
                    getDailyRaces(currentRaceOddsUrl); 
                    console.warn("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ‡ã‚¤ãƒªãƒ¼ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€å†å–å¾—ã—ã¾ã™ã€‚");
                }


                // 3. ã‚ªãƒƒã‚ºãƒ†ãƒ¼ãƒ–ãƒ«ã®å¾©å…ƒ
                if (window.currentOddsData && window.currentOddsData.length > 0 && currentRaceOddsUrl) {
                    // ãƒ¬ãƒ¼ã‚¹åã‚‚å¾©å…ƒ
                    const raceNameDisplay = document.getElementById('raceDetails').querySelector('h3');
                    if (raceNameDisplay) {
                        raceNameDisplay.textContent = `ãƒ¬ãƒ¼ã‚¹è©³ç´°ã¨ã‚ªãƒƒã‚º: ${getRaceNameFromUrl(currentRaceOddsUrl)}`;
                    }
                    renderOddsTable(window.currentOddsData);
                    // é©åˆ‡ãªè¡¨ç¤ºä½ç½®ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                    document.getElementById('raceDetails').scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else if (currentRaceOddsUrl) {
                    getRaceOdds(currentRaceOddsUrl); 
                    console.warn("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ã‚ªãƒƒã‚ºãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€å†å–å¾—ã—ã¾ã™ã€‚");
                } else {
                    console.log("å¾©å…ƒã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                }
            } else {
                console.log("åˆå›ãƒ­ãƒ¼ãƒ‰ã§ã™ã€‚");
                //getSchedule(); // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã‚‚ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è‡ªå‹•å–å¾—
            }
        });

        const mainRacesListDiv = document.getElementById('mainRacesList');
        const dailyRacesListDiv = document.getElementById('dailyRacesList');
        const raceDetailsDiv = document.getElementById('raceDetails');
        const getScheduleButton = document.getElementById('getScheduleButton');
        const refreshOddsButton = document.getElementById('refreshOddsButton');
        const loadingMainRaces = document.getElementById('loadingMainRaces');
        const loadingDailyRaces = document.getElementById('loadingDailyRaces');
        const loadingRaceDetails = document.getElementById('loadingRaceDetails');

        let currentRaceOddsUrl = ''; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentOddsData = []; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ãƒ‡ã‚¤ãƒªãƒ¼ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
        // window.currentScheduleData, window.currentDailyRacesData ã¯ DOMContentLoaded ã§åˆæœŸåŒ–æ¸ˆã¿

        function disableElements(elements, disable) {
            elements.forEach(el => {
                if (disable) {
                    el.classList.add('disabled-link');
                    if (el.tagName === 'BUTTON' || el.tagName === 'INPUT') {
                        el.disabled = true;
                    }
                } else {
                    el.classList.remove('disabled-link');
                    if (el.tagName === 'BUTTON' || el.tagName === 'INPUT') {
                        el.disabled = false;
                    }
                }
            });
        }
        
        // ãƒ¬ãƒ¼ã‚¹URLã‹ã‚‰ãƒ¬ãƒ¼ã‚¹åã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        // daily_races_dataã®å„è¦ç´ ã«'ãƒ¬ãƒ¼ã‚¹å'ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹ã“ã¨ã‚’æƒ³å®š
        function getRaceNameFromUrl(url) {
            const foundRace = window.currentDailyRacesData.find(race => race.URL === url);
            return foundRace ? `${foundRace['ãƒ¬ãƒ¼ã‚¹ç•ªå·']} ${foundRace['ãƒ¬ãƒ¼ã‚¹å']}` : "ãƒ¬ãƒ¼ã‚¹åä¸æ˜";
        }


        async function getSchedule() {
            // console.log(`getScheduleå‘¼ã³å‡ºã—: å¹´=${document.getElementById('year').value}, æœˆ=${document.getElementById('month').value}`); # DEBUGãƒ­ã‚°
            const year = document.getElementById('year').value;
            const month = document.getElementById('month').value;

            disableElements([getScheduleButton], true);
            disableElements(document.querySelectorAll('.race-item, .daily-race-item'), true);
            loadingMainRaces.style.display = 'block';
            mainRacesListDiv.innerHTML = '<h3>ãƒ¬ãƒ¼ã‚¹ä¸€è¦§:</h3><p>èª­ã¿è¾¼ã¿ä¸­...</p>';

            try {
                const response = await fetch(`/get_schedule?year=${year}&month=${month}`);
                const data = await response.json();
                if (data.error) {
                    mainRacesListDiv.innerHTML = `<p>ã‚¨ãƒ©ãƒ¼: ${data.error}</p>`; 
                    return;
                }
                currentScheduleData = data; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
                displaySchedule(data);
            } catch (error) {
                console.error('ãƒ¬ãƒ¼ã‚¹æ—¥ç¨‹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                mainRacesListDiv.innerHTML = '<h3>ãƒ¬ãƒ¼ã‚¹ä¸€è¦§:</h3><p>ãƒ¬ãƒ¼ã‚¹æ—¥ç¨‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
            } finally {
                loadingMainRaces.style.display = 'none';
                disableElements([getScheduleButton], false);
                disableElements(document.querySelectorAll('.race-item, .daily-race-item'), false);
            }
        }

        function displaySchedule(races) {
            mainRacesListDiv.innerHTML = '<h3>ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ä¸€è¦§:</h3>';
            if (races.length > 0) {
                races.forEach(race => {
                    const p = document.createElement('p');
                    p.className = 'race-item';
                    p.innerHTML = `<span>ğŸ“… ${race.æ—¥ä»˜}</span><span>${race.é–‹å‚¬ç«¶é¦¬å ´}</span><span>(${race.ãƒ¬ãƒ¼ã‚¹å})</span>`;
                    p.onclick = () => getDailyRaces(race.URL);
                    mainRacesListDiv.appendChild(p);
                });
            } else {
                mainRacesListDiv.innerHTML += '<p>ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
            }
        }

        async function getDailyRaces(mainRaceUrl) {
            console.log("getDailyRaceså‘¼ã³å‡ºã—: URL=", mainRaceUrl);
            const clickableElements = document.querySelectorAll('.race-item, .daily-race-item, .input-group button');
            disableElements(clickableElements, true);

            loadingDailyRaces.style.display = 'block';
            dailyRacesListDiv.innerHTML = '<h3>åŒæ—¥é–‹å‚¬ã®å…¨ãƒ¬ãƒ¼ã‚¹:</h3><p>èª­ã¿è¾¼ã¿ä¸­...</p>';

            try {
                const response = await fetch(`/get_daily_races?url=${encodeURIComponent(mainRaceUrl)}`);
                const races = await response.json();
                if (races.error) { 
                    dailyRacesListDiv.innerHTML = `<p>ã‚¨ãƒ©ãƒ¼: ${races.error}</p>`; 
                    return;
                }
                console.log("åŒæ—¥é–‹å‚¬ãƒ¬ãƒ¼ã‚¹URLå–å¾—æˆåŠŸ:", races);
                window.currentDailyRacesData = races; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
                displayDailyRaces(races);
                dailyRacesListDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (error) {
                console.error('åŒæ—¥é–‹å‚¬ãƒ¬ãƒ¼ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                dailyRacesListDiv.innerHTML = '<h3>åŒæ—¥é–‹å‚¬ã®å…¨ãƒ¬ãƒ¼ã‚¹:</h3><p>åŒæ—¥é–‹å‚¬ãƒ¬ãƒ¼ã‚¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
            } finally {
                disableElements(clickableElements, false);
                loadingDailyRaces.style.display = 'none';
            }
        }

        function displayDailyRaces(races) {
            dailyRacesListDiv.innerHTML = '<h3>åŒæ—¥é–‹å‚¬ã®å…¨ãƒ¬ãƒ¼ã‚¹:</h3>';
            if (races.length > 0) {
                races.forEach(race => {
                    const p = document.createElement('p');
                    p.className = 'daily-race-item';
                    p.textContent = `${race['ãƒ¬ãƒ¼ã‚¹ç•ªå·']} ${race['ãƒ¬ãƒ¼ã‚¹å']}`; 
                    p.onclick = () => getRaceOdds(race.URL);
                    dailyRacesListDiv.appendChild(p);
                });
            } else {
                dailyRacesListDiv.innerHTML += '<p>åŒæ—¥é–‹å‚¬ã®ãƒ¬ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
            }
        }

        async function getRaceOdds(raceUrl, isRefresh = false) {
            console.log(`getRaceOddså‘¼ã³å‡ºã—: URL=${raceUrl}, æ›´æ–°ãƒ¢ãƒ¼ãƒ‰=${isRefresh}`);
            currentRaceOddsUrl = raceUrl;
            
            const h3Title = raceDetailsDiv.querySelector('h3');
            raceDetailsDiv.innerHTML = ''; 

            if (h3Title) {
                raceDetailsDiv.appendChild(h3Title);
            } else {
                const newH3 = document.createElement('h3');
                newH3.textContent = 'ãƒ¬ãƒ¼ã‚¹è©³ç´°ã¨ã‚ªãƒƒã‚º:';
                raceDetailsDiv.appendChild(newH3);
            }
            
            raceDetailsDiv.appendChild(refreshOddsButton);
            refreshOddsButton.style.display = 'block';


            const clickableElements = document.querySelectorAll('.race-item, .daily-race-item, .input-group button');
            disableElements(clickableElements, true);

            loadingRaceDetails.style.display = 'block';
            
            const messageP = document.createElement('p');
            messageP.textContent = isRefresh ? 'ã‚ªãƒƒã‚ºæƒ…å ±æ›´æ–°ä¸­...' : 'ã‚ªãƒƒã‚ºæƒ…å ±èª­ã¿è¾¼ã¿ä¸­...';
            raceDetailsDiv.appendChild(messageP);


            try {
                const response = await fetch(`/get_race_odds?url=${encodeURIComponent(raceUrl)}`);
                const result = await response.json();
                console.log("DEBUG: ã‚ªãƒƒã‚ºãƒ‡ãƒ¼ã‚¿å–å¾—çµæœ (APIã‹ã‚‰ã®å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿):", result);

                if (result.success) {
                    // --- START MODIFIED ---
                    // APIã‹ã‚‰è¿”ã•ã‚ŒãŸpredictionsï¼ˆé¦¬åã€ã‚ªãƒƒã‚ºã€ã‚¹ã‚³ã‚¢ãªã©å…¨ã¦ã®æƒ…å ±ã‚’å«ã‚€ï¼‰ã‚’
                    // currentOddsData ã«ç›´æ¥ä»£å…¥ã—ã¾ã™ã€‚
                    currentOddsData = result.predictions; 
                    // console.log("DEBUG: currentOddsDataã«APIã‹ã‚‰ã®æ–°ã—ã„predictionsã‚’ä¸Šæ›¸ãã—ã¾ã—ãŸ:", JSON.parse(JSON.stringify(currentOddsData))); # DEBUGãƒ­ã‚°
                    // console.log("DEBUG: currentOddsData.length (ä¸Šæ›¸ãå¾Œ):", currentOddsData.length); # DEBUGãƒ­ã‚°
                    // if (currentOddsData.length > 0) {
                    //     console.log("DEBUG: currentOddsData[0] (ä¸Šæ›¸ãå¾Œ):", currentOddsData[0]); # DEBUGãƒ­ã‚°
                    // }
                    // --- END MODIFIED ---

                    // ã‚ªãƒƒã‚ºæ›´æ–°å¾Œã‚‚ã‚½ãƒ¼ãƒˆçŠ¶æ…‹ã‚’ç¶­æŒã—ãŸã„å ´åˆã®ã¿ã€ã‚½ãƒ¼ãƒˆã‚’å†é©ç”¨
                    // --- START MODIFIED ---
                    if (isRefresh && currentSortColumn) { 
                        // console.log(`DEBUG: ã‚½ãƒ¼ãƒˆçŠ¶æ…‹ã‚’ç¶­æŒã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å†ã‚½ãƒ¼ãƒˆä¸­: ã‚«ãƒ©ãƒ =${currentSortColumn}, æ–¹å‘=${currentSortDirection}`); # DEBUGãƒ­ã‚°
                        sortOddsData(currentOddsData, currentSortColumn, currentSortDirection);
                    } else if (!isRefresh) {
                        // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã®ã¿ã‚½ãƒ¼ãƒˆçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                        currentSortColumn = null;
                        currentSortDirection = 'asc';
                    }
                    // --- END MODIFIED ---

                    renderOddsTable(currentOddsData);
                    if (!isRefresh) { 
                        raceDetailsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                } else {
                    console.error("ERROR: getOdds - APIå ±å‘Šå¤±æ•—:", result.error);
                    const currentH3 = raceDetailsDiv.querySelector('h3');
                    raceDetailsDiv.innerHTML = '';
                    if (currentH3) raceDetailsDiv.appendChild(currentH3);
                    raceDetailsDiv.appendChild(refreshOddsButton);
                    raceDetailsDiv.innerHTML += `<p>ã‚ªãƒƒã‚ºã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}</p>`;
                }
            } catch (error) {
                console.error('ERROR: getOdds - ã‚ªãƒƒã‚ºãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¾ãŸã¯å‡¦ç†ã«å¤±æ•—:', error);
                const currentH3 = raceDetailsDiv.querySelector('h3');
                raceDetailsDiv.innerHTML = '';
                if (currentH3) currentH3.appendChild(raceDetailsDiv);
                raceDetailsDiv.appendChild(refreshOddsButton);
                raceDetailsDiv.innerHTML += `<p>ã‚ªãƒƒã‚ºã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>`;
            } finally {
                disableElements(clickableElements, false);
                loadingRaceDetails.style.display = 'none';
            }
        }

        function renderOddsTable(data) {
            // console.log("DEBUG: renderOddsTableå‘¼ã³å‡ºã—ã€‚æœ€çµ‚è¡¨ç¤ºãƒ‡ãƒ¼ã‚¿:", JSON.parse(JSON.stringify(data))); # DEBUGãƒ­ã‚°
            // if (data.length > 0) { # DEBUGãƒ­ã‚°
            //     console.log("DEBUG: renderOddsTable - Sample horse in data:", data[0]); # DEBUGãƒ­ã‚°
            //     console.log("DEBUG: renderOddsTable - é¦¬ç•ª for first horse:", data[0]['é¦¬ç•ª']); # DEBUGãƒ­ã‚°
            //     console.log("DEBUG: renderOddsTable - é¦¬å for first horse:", data[0]['é¦¬å']); # DEBUGãƒ­ã‚°
            //     console.log("DEBUG: renderOddsTable - å˜å‹ã‚ªãƒƒã‚º for first horse:", data[0]['å˜å‹ã‚ªãƒƒã‚º']); # DEBUGãƒ­ã‚°
            //     console.log("DEBUG: renderOddsTable - è¤‡å‹ã‚ªãƒƒã‚º for first horse:", data[0]['è¤‡å‹ã‚ªãƒƒã‚º']); # DEBUGãƒ­ã‚°
            //     console.log("DEBUG: renderOddsTable - ã‚­ãƒ£ãƒªã‚¢æœ€é«˜ã‚¹ã‚³ã‚¢ for first horse:", data[0]['ã‚­ãƒ£ãƒªã‚¢æœ€é«˜ã‚¹ã‚³ã‚¢']); # DEBUGãƒ­ã‚°
            //     console.log("DEBUG: renderOddsTable - ã‚­ãƒ£ãƒªã‚¢æœ€é«˜ã‚¹ã‚³ã‚¢æ—¥æ™‚ for first horse:", data[0]['ã‚­ãƒ£ãƒªã‚¢æœ€é«˜ã‚¹ã‚³ã‚¢æ—¥æ™‚']); # DEBUGãƒ­ã‚°
            // } # DEBUGãƒ­ã‚°
            let tableHtml = `
                <table class="odds-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-column="é¦¬ç•ª">é¦¬ç•ª <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-column="é¦¬å">é¦¬å <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-column="å˜å‹ã‚ªãƒƒã‚º">å˜å‹ã‚ªãƒƒã‚º <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-column="è¤‡å‹ã‚ªãƒƒã‚º">è¤‡å‹ã‚ªãƒƒã‚º <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-column="ã‚­ãƒ£ãƒªã‚¢æœ€é«˜ã‚¹ã‚³ã‚¢">æœ€é«˜ã‚¹ã‚³ã‚¢ <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-column="ã‚­ãƒ£ãƒªã‚¢æœ€é«˜ã‚¹ã‚³ã‚¢æ—¥æ™‚">æœ€é«˜ã‚¹ã‚³ã‚¢æ—¥æ™‚ <i class="fas fa-sort"></i></th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            data.forEach(horse => {
                tableHtml += `
                    <tr>
                        <td>${horse['é¦¬ç•ª'] || 'N/A'}</td>
                        <td><span class="horse-name-link" onclick="viewHorseCareer('${encodeURIComponent(horse['é¦¬å'] || '')}')">${horse['é¦¬å'] || 'N/A'}</span></td>
                        <td>${horse['å˜å‹ã‚ªãƒƒã‚º'] || 'N/A'}</td>
                        <td>${horse['è¤‡å‹ã‚ªãƒƒã‚º'] || 'N/A'}</td>
                        <td>${horse['ã‚­ãƒ£ãƒªã‚¢æœ€é«˜ã‚¹ã‚³ã‚¢'] || 'N/A'}</td>
                        <td>${horse['ã‚­ãƒ£ãƒªã‚¢æœ€é«˜ã‚¹ã‚³ã‚¢æ—¥æ™‚'] || 'N/A'}</td>
                    </tr>
                `;
            });
            tableHtml += `</tbody></table>`;

            const currentH3 = raceDetailsDiv.querySelector('h3');
            raceDetailsDiv.innerHTML = '';
            if (currentH3) raceDetailsDiv.appendChild(currentH3);
            raceDetailsDiv.appendChild(refreshOddsButton);
            
            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-responsive';
            tableContainer.innerHTML = tableHtml;
            raceDetailsDiv.appendChild(tableContainer);

            refreshOddsButton.style.display = 'block';

            attachSortEventListeners();
            updateSortIcons();
            console.log("ã‚ªãƒƒã‚ºãƒ†ãƒ¼ãƒ–ãƒ«ãŒå†æç”»ã•ã‚Œã¾ã—ãŸã€‚");
        }

        function attachSortEventListeners() {
            document.querySelectorAll('.odds-table th.sortable').forEach(header => {
                header.removeEventListener('click', handleSortClick);
                header.addEventListener('click', handleSortClick);
            });
        }

        function handleSortClick(event) {
            const column = event.currentTarget.dataset.column;
            console.log(`ã‚½ãƒ¼ãƒˆã‚¯ãƒªãƒƒã‚¯: ã‚«ãƒ©ãƒ =${column}`);

            if (currentSortColumn === column) {
                currentSortDirection = (currentSortDirection === 'asc' ? 'desc' : 'asc');
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }
            console.log(`æ–°ã—ã„ã‚½ãƒ¼ãƒˆçŠ¶æ…‹: ã‚«ãƒ©ãƒ =${currentSortColumn}, æ–¹å‘=${currentSortDirection}`);

            sortOddsData(currentOddsData, currentSortColumn, currentSortDirection);
            renderOddsTable(currentOddsData);
        }

        function sortOddsData(dataArray, column, direction) {
            console.log(`sortOddsDataå‘¼ã³å‡ºã—: ã‚«ãƒ©ãƒ =${column}, æ–¹å‘=${direction}`);
            dataArray.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                if (['é¦¬ç•ª', 'å˜å‹ã‚ªãƒƒã‚º', 'ã‚­ãƒ£ãƒªã‚¢æœ€é«˜ã‚¹ã‚³ã‚¢'].includes(column)) {
                    valA = parseFloat(valA);
                    valB = parseFloat(valB);
                    if (isNaN(valA) && isNaN(valB)) return 0;
                    if (isNaN(valA)) return direction === 'asc' ? 1 : -1;
                    if (isNaN(valB)) return direction === 'asc' ? -1 : 1;
                }
                else if (column === 'è¤‡å‹ã‚ªãƒƒã‚º') {
                    valA = parseFloat(String(valA).split('-')[0]);
                    valB = parseFloat(String(valB).split('-')[0]);
                    if (isNaN(valA) && isNaN(valB)) return 0;
                    if (isNaN(valA)) return direction === 'asc' ? 1 : -1;
                    if (isNaN(valB)) return direction === 'asc' ? -1 : 1;
                }
                else if (column === 'ã‚­ãƒ£ãƒªã‚¢æœ€é«˜ã‚¹ã‚³ã‚¢æ—¥æ™‚') {
                    const dateA = valA !== 'N/A' ? new Date(valA.replace(/\./g, '/')) : null;
                    const dateB = valB !== 'N/A' ? new Date(valB.replace(/\./g, '/')) : null;

                    if (!dateA && !dateB) return 0;
                    if (!dateA) return direction === 'asc' ? 1 : -1;
                    if (!dateB) return direction === 'asc' ? -1 : 1;

                    if (dateA < dateB) {
                        return direction === 'asc' ? -1 : 1;
                    }
                    if (dateA > dateB) {
                        return direction === 'asc' ? 1 : -1;
                    }
                    return 0;
                }

                if (valA < valB) {
                    return direction === 'asc' ? -1 : 1;
                }
                if (valA > valB) {
                    return direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
        }
        // updateSortIconsé–¢æ•°ã¯ãã®ã¾ã¾
        function updateSortIcons() {
            document.querySelectorAll('.odds-table th.sortable').forEach(header => {
                const icon = header.querySelector('i');
                header.classList.remove('asc', 'desc');
                icon.classList.remove('fa-sort-up', 'fa-sort-down', 'fa-sort');
                icon.classList.add('fa-sort');

                if (header.dataset.column === currentSortColumn) {
                    header.classList.add(currentSortDirection);
                    if (currentSortDirection === 'asc') {
                        icon.classList.remove('fa-sort');
                        icon.classList.add('fa-sort-up');
                    } else {
                        icon.classList.remove('fa-sort');
                        icon.classList.add('fa-sort-down');
                    }
                }
            });
        }
        // é¦¬åã‚¯ãƒªãƒƒã‚¯æ™‚ã®é–¢æ•°: GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã§é·ç§»
        function viewHorseCareer(horseName) {
            const year = document.getElementById('year').value;
            const month = document.getElementById('month').value;
            
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã™æƒ…å ±ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
            const encodedHorseName = encodeURIComponent(horseName);
            const encodedRaceUrl = encodeURIComponent(currentRaceOddsUrl || '');
            const encodedYear = encodeURIComponent(year || '');
            const encodedMonth = encodeURIComponent(month || '');

            // GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã§é·ç§»
            let url = `/horse_career/${encodedHorseName}?`;
            if (encodedRaceUrl) url += `race_url=${encodedRaceUrl}&`;
            if (encodedYear) url += `year=${encodedYear}&`;
            if (encodedMonth) url += `month=${encodedMonth}&`;
            
            // æœ«å°¾ã®ä½™åˆ†ãª '&' ã¾ãŸã¯ '?' ã‚’å‰Šé™¤
            if (url.endsWith('?') || url.endsWith('&')) {
                url = url.slice(0, -1);
            }
            window.location.href = url;
        }

    </script>
</body>

</html>